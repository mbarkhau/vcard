<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Visitenkarten Generator</title>
    <style type="text/css">
        body {
            font-family: sans-serif;
        }

        #form {
            max-width: 20em;
            margin: 1em auto;
            text-align: center;
        }
        #mail-sig {
            max-width: 30em;
            margin: 1em auto;
        }
        textarea {
            width: 50em;
            height: 20em;
            padding: 1em;
            font-size: 8pt;
        }
        #mail-sig-preview {
            outline: 1px solid #888;
            padding: 1em;
        }

        label {
            min-width: 8em;
            display: inline-block;
            text-align: left;
        }
        #form div {
            margin: 0.3em;
        }

        @keyframes flashButton {
          0%   { background-color: #6F6; }
          100% { background-color: #EEE; }
        }

        button {
            cursor: pointer;
            line-height: 1.3em;
            background-color: #EEE;
        }
        button.clicked {
            animation: flashButton 150ms ease;
        }
    </style>

    <script type="text/javascript" src="pdf-lib.js"></script>
    <script src="fontkit.umd.js"></script>
    <script type="text/javascript" src="download.js"></script>

</head>
<body>
    <div id="form">
        <div>
            <label>Vorname</label>
            <input type="text" name="vorname" placeholder="Max">
        </div>
        <div>
            <label>Nachname</label>
            <input type="text" name="nachname" placeholder="Mustermann">
        </div>
        <div>
            <label>Rolle/Aufgabe</label>
            <input type="text" name="rolle" placeholder="Parteimitglied">
        </div>
        <div>
            <label>Adresse Zeile 1</label>
            <input type="text" name="adresse-1" placeholder="Postfach 75 02 07">
        </div>
        <div>
            <label>Adresse Zeile 2</label>
            <input type="text" name="adresse-2" placeholder="81332 M√ºnchen">
        </div>
        <div>
            <label>E-Mail</label>
            <input type="text" name="email" placeholder="max.mustermann@die-libertaeren.de">
        </div>
        <div>
            <label>Telefon</label>
            <input type="text" name="telefon" placeholder="01515 000000">
        </div>
        <div>
            <label>X-Profil</label>
            <input type="text" name="x-profil" placeholder="@MaxMuster">
        </div>

        <button id="gen-pdf">PDF Generieren</button>
    </div>

    <hr>

    <div id="mail-sig">
        <button id="copy-raw">üóê Kopieren</button>
        <label>E-Mail Signatur f√ºr Thunderbird:</label>
        <br>
        <br>

        <textarea id="mail-sig-html"></textarea>

        <br>
        <br>

        <button id="copy-formatted">üóê Kopieren</button>
        <label>E-Mail Signatur f√ºr Outlook:</label>
        <br>
        <br>

        <div id="mail-sig-preview"></div>
    </div>

<script type="text/javascript">
    const { PDFDocument, StandardFonts, rgb, cymk } = PDFLib;

    const DEFAULT_X_PROFIL = "Die_Libertaeren"
    const DEFAULT_TELEFON = "+49 159 0632 0502"

    const width_mm = 91
    const height_mm = 61
    const pt_per_mm = 72 / 25.4
    const width_pt = width_mm * pt_per_mm
    const height_pt = height_mm * pt_per_mm

    function getInfo() {
        var vorname = document.getElementsByName('vorname')[0].value || "Max"
        var nachname = document.getElementsByName('nachname')[0].value || "Mustermann"
        var rolle = document.getElementsByName('rolle')[0].value || "Parteimitglied"

        var x_profil = document.getElementsByName('x-profil')[0].value || DEFAULT_X_PROFIL
        if (x_profil.slice(0, 1) == "@") {
            x_profil = x_profil.slice(1)
        }
        var default_email = `
            ${vorname.toLowerCase().replace("√§", "ae").replace("√∂", "oe").replace("√º", "ue")}
            .
            ${nachname.toLowerCase().replace("√§", "ae").replace("√∂", "oe").replace("√º", "ue")}
            @die-libertaeren.de
        `

        default_email = default_email.replaceAll(/\s/g, "")

        return {
            vorname  : vorname,
            nachname : nachname,
            rolle    : rolle,
            adresse_1: document.getElementsByName('adresse-1')[0].value || "Postfach 75 02 07",
            adresse_2: document.getElementsByName('adresse-2')[0].value || "81332 M√ºnchen",
            email    : document.getElementsByName('email')[0].value || default_email,
            telefon  : document.getElementsByName('telefon')[0].value || DEFAULT_TELEFON,
            x_profil : x_profil,
            short_name: (vorname.slice(0, 1) + nachname.slice(0, 3)).toLowerCase(),
        }
    }

    document.getElementById("gen-pdf").addEventListener('click', async function() {
        const info = getInfo()

        const gothamBoldPromise = fetch("Gotham-Font/GothamBold.ttf").then(res => res.arrayBuffer())
        const robotoBoldPromise = fetch("Roboto-Font/Roboto-Bold.ttf").then(res => res.arrayBuffer())

        const frontPromise = fetch("vcard-front-v3.png").then((res) => res.arrayBuffer())
        // const backPromise = fetch("vcard-back-fontdebug.png").then((res) => res.arrayBuffer())
        const backPromise = fetch("vcard-back-v2.png").then((res) => res.arrayBuffer())

        const pdfDoc = await PDFDocument.create()
        pdfDoc.registerFontkit(fontkit)

        const frontImage = await pdfDoc.embedPng(await frontPromise)
        const backImage = await pdfDoc.embedPng(await backPromise)

        const gothamBoldFont = await pdfDoc.embedFont(await gothamBoldPromise)
        const robotoBoldFont = await pdfDoc.embedFont(await robotoBoldPromise)

        const back = pdfDoc.addPage([width_mm * pt_per_mm, height_mm * pt_per_mm])
        const front = pdfDoc.addPage([width_mm * pt_per_mm, height_mm * pt_per_mm])

        front.drawRectangle({x: -50, y: -50, width: width_pt + 100, height: height_pt + 100, color: rgb(0, 0, 0)})
        back.drawRectangle({x: -50, y: -50, width: width_pt + 100, height: height_pt + 100, color: rgb(0.984, 0.690, 0.082)})

        front.drawImage(frontImage, {x: 0, y: 0, width: width_pt, height: height_pt})
        back.drawImage(backImage, {x: 0, y: 0, width: width_pt, height: height_pt})

        function cutMarker(x, y, w, h) {
            back.drawLine({
                thickness: 0.4, color: rgb(0, 0, 0),
                start: {x: x * pt_per_mm, y: y * pt_per_mm},
                end  : {x: (x + w) * pt_per_mm, y: (y + h) * pt_per_mm}
            })
        }

        cutMarker(0, 3, 1.5, 0)
        cutMarker(0, height_mm - 3, 1.5, 0)

        cutMarker(width_mm, 3, -1.5, 0)
        cutMarker(width_mm, height_mm - 3, -1.5, 0)

        cutMarker(3, 0, 0, 1.5)
        cutMarker(width_mm - 3, 0, 0, 1.5)

        cutMarker(3, height_mm, 0, -1.5)
        cutMarker(width_mm - 3, height_mm, 0, -1.5)


        function textRenderer(page, opts) {
            return function drawText(text, x, y) {
                opts.x = x
                opts.y = y
                opts.size = opts.size || 11.5
                opts.color = opts.color || rgb(0, 0, 0)
                opts.letterSpacing = opts.letterSpacing || 0.0

                for (const char of text) {
                    const charWidth = opts.font.widthOfTextAtSize(char, opts.size);
                    page.drawText(char, opts);
                    opts.x += charWidth + opts.letterSpacing;
                }
            }
        }

        const renderTitle = textRenderer(back, {
            size: 9.5,
            font: gothamBoldFont,
            color: rgb(0.0, 0.0, 0.0),
            letterSpacing: -0.4,
        })

        renderTitle(info.vorname.toUpperCase(), 30.0, 139)
        renderTitle(info.nachname.toUpperCase(), 30.0, 130)

        const renderRole = textRenderer(back, {
            size: 7.0,
            font: gothamBoldFont,
            color: rgb(0.0, 0.0, 0.0),
            letterSpacing: -0.25,
        })

        renderRole(info.rolle.toUpperCase(), 30.0, 112)

        const renderInfo = textRenderer(back, {
            size: 7.0,
            font: robotoBoldFont,
            color: rgb(0.0, 0.0, 0.0),
            letterSpacing: -0.10,
        })

        renderInfo(info.adresse_1, 40.0, 95 - 3)
        renderInfo(info.adresse_2, 40.0, 95 - 10.2)
        renderInfo(info.email    , 40.0, 95 - 22.8)
        renderInfo(info.telefon  , 40.0, 95 - 36.2)
        renderInfo('@' + info.x_profil, 40.0, 95 - 48.8)

        var date = new Date().toISOString().replaceAll("-", "").replaceAll(":", "").slice(0, 15)

        const pdfBytes = await pdfDoc.save()
        download(pdfBytes, `die-libertaeren-85x55-vcard-${info.short_name}-${date}.pdf`, "application/pdf");
    });

    function setSignaturePreview(previewHtml) {
        document.getElementById('mail-sig-preview').innerHTML = (
            previewHtml
            .replace(/<pre>\s*/gm, "<pre>")
            .replace(/\s*<\/pre>/gm, "</pre>")
        )
    }

    function updateEMailSig() {
        const info = getInfo()
        var clean_telefon = info.telefon
        clean_telefon = clean_telefon.replaceAll("-", "")
        clean_telefon = clean_telefon.replaceAll(" ", "")

        var mailSigHTML = `
Mit freundlichen Gr√º√üen<br>
${info.vorname} ${info.nachname}<br>
${info.rolle}<br>

<font size="2" color="#888">
<pre>
E-Mail   : <a href="mailto:${info.email}">${info.email}</a>
Telefon  : <a href="tel:${clean_telefon}">${info.telefon}</a>
X/Twitter: <a href="https://x.com/${info.x_profil}">@${info.x_profil}</a>
</pre>

DIE LIBERT√ÑREN e.V.<br>
Postfach 75 02 07<br>
81332 M√ºnchen<br>
<br>
Vereinsregister-Nummer 209533<br>
Amtsgericht M√ºnchen<br>
Gesch√§ftsf√ºhrung: Florian Handwerker<br>

<pre>
Webseite : <a href="https://die-libertaeren.de/">die-libertaeren.de</a>
E-Mail   : <a href="mailto:info@die-libertaeren.de">info@die-libertaeren.de</a>
Telefon  : <a href="tel:${DEFAULT_TELEFON.replaceAll(" ", "")}">${DEFAULT_TELEFON}</a>
X/Twitter: <a href="https://x.com/Die_Libertaeren">@Die_Libertaeren</a>
YouTube  : <a href="https://www.youtube.com/@die_libertaeren">youtube.com/@Die_Libertaeren</a>
</pre>
</font>
        `
        if (info.x_profil == DEFAULT_X_PROFIL) {
            mailSigHTML = mailSigHTML.replace(/^X\/Twitter.*/m, "")
            mailSigHTML = mailSigHTML.replace(/^Telefon  :/m, "Telefon:")
            mailSigHTML = mailSigHTML.replace(/^E-Mail   :/m, "E-Mail :")
        }
        if (info.telefon == DEFAULT_TELEFON) {
            mailSigHTML = mailSigHTML.replace(/^Telefon.*/m, "")
            mailSigHTML = mailSigHTML.replace(/^E-Mail :/m, "E-Mail:")
        }

        mailSigHTML = mailSigHTML.trim()
        mailSigHTML = mailSigHTML.replaceAll("\n\n", "\n")

        document.getElementById('mail-sig-html').value = mailSigHTML
        setSignaturePreview(mailSigHTML)
    }

    document.querySelector('textarea').addEventListener('keyup', function() {
        setSignaturePreview(document.getElementById('mail-sig-html').value);
    })

    updateEMailSig();

    const inputNodes = document.querySelectorAll('input')
    for (var i = 0; i < inputNodes.length; i++) {
        inputNodes[i].addEventListener('keyup', updateEMailSig);
    }

    const copyRawButton = document.getElementById('copy-raw')
    const copyFormattedButton = document.getElementById('copy-formatted')

    copyRawButton.addEventListener('click', function() {
        const promise = navigator.clipboard.writeText(document.getElementById('mail-sig-preview').innerHTML)
        promise.then(function() {
            copyRawButton.classList.add('clicked')
            setTimeout(function() {
                copyRawButton.classList.remove('clicked')
            }, 300)
        })
    })

    copyFormattedButton.addEventListener('click', function() {
        const htmlText = document.getElementById('mail-sig-preview').innerHTML
        const htmlBlob = new Blob([ htmlText ], {type: 'text/html'});
        const promise = navigator.clipboard.write([new ClipboardItem({'text/html': htmlBlob })])

        promise.then(function() {
            copyFormattedButton.classList.add('clicked')
            setTimeout(function() {
                copyFormattedButton.classList.remove('clicked')
            }, 300)
        })
    })


</script>
</body>
</html>